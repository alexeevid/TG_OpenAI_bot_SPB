name: Open PR (manual)

on:
  workflow_dispatch:
    inputs:
      change_type:
        description: 'Type of change: single or zip'
        required: true
        default: 'single'
      file_path:
        description: 'Path to file (for change_type=single)'
        required: false
        default: 'README.md'
      file_content:
        description: 'New file content (paste here, multiline OK)'
        required: false
      zip_url:
        description: 'Public URL to a ZIP (unpacked into repo root) for change_type=zip'
        required: false
      pr_title:
        description: 'PR title'
        required: false
        default: 'Automated update'
      pr_body:
        description: 'PR body'
        required: false
        default: 'Proposed changes from assistant workflow'
      commit_message:
        description: 'Commit message'
        required: false
        default: 'chore: automated update'

permissions:
  contents: write
  pull-requests: write

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- Вариант А: правим один файл, контент берём из input
      - name: Apply changes (single file)
        if: ${{ github.event.inputs.change_type == 'single' }}
        shell: bash
        run: |
          set -euo pipefail
          path="${{ github.event.inputs.file_path }}"
          mkdir -p "$(dirname "$path")"
          cat > "$path" <<'EOF_CONTENT'
${{ github.event.inputs.file_content }}
EOF_CONTENT
          echo "Wrote $path"

      # --- Вариант Б: скачиваем ZIP и распаковываем в корень репозитория
      - name: Apply changes from ZIP
        if: ${{ github.event.inputs.change_type == 'zip' }}
        shell: bash
        run: |
          set -euo pipefail
          url="${{ github.event.inputs.zip_url }}"
          if [ -z "$url" ]; then
            echo "::error::zip_url is empty"; exit 1
          fi
          echo "Downloading $url"
          curl -fsSL "$url" -o /tmp/patch.zip
          unzip -o /tmp/patch.zip -d .
          echo "Unzipped:"
          ls -la

      # Узнаём, есть ли изменения
      - name: Detect changes
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          cnt="$(git status --porcelain | wc -l || true)"
          echo "changed=$cnt" >> "$GITHUB_OUTPUT"
          echo "Changed files: $cnt"

      # Создаём Pull Request (если есть изменения)
      - name: Create Pull Request
        if: ${{ steps.diff.outputs.changed != '0' }}
        uses: peter-evans/create-pull-request@v6
        with:
          # Если есть секрет GH_TOKEN, используем его; иначе встроенный GITHUB_TOKEN
          token: ${{ secrets.GH_TOKEN || github.token }}
          commit-message: ${{ github.event.inputs.commit_message }}
          title: ${{ github.event.inputs.pr_title }}
          body: ${{ github.event.inputs.pr_body }}
          branch: bot-pr/${{ github.run_id }}-${{ github.run_number }}
          delete-branch: true
          author: assistant-bot <assistant-bot@users.noreply.github.com>
          committer: assistant-bot <assistant-bot@users.noreply.github.com>

      # Если правок не было — в Summary короткое сообщение
      - name: No changes summary
        if: ${{ steps.diff.outputs.changed == '0' }}
        run: |
          echo "No changes detected. Nothing to commit." >> "$GITHUB_STEP_SUMMARY"
