# Hotfix: missing functions for text & voice handlers

Дата: 2025-09-20

## Что внутри

Этот архив добавляет **без правок ваших существующих файлов** недостающие функции, из‑за которых падали `on_text` и `on_voice`:

- `embed_query`
- `_build_prompt`
- `_llm_answer_no_rag`
- `_llm_answer_with_rag`

Мы делаем это через стандартный механизм Python — `sitecustomize.py`, который автоматически импортируется при запуске.
Он тянет модуль `services/missing_impl.py`, где функции реализованы и **зарегистрированы в `builtins`**.
Благодаря этому вызовы вида `await embed_query(...)` начнут успешно работать без добавления импортов в `handlers/telegram_core.py`.

## Состав

```
/sitecustomize.py
/services/__init__.py
/services/missing_impl.py
```

## Как установить

1. Скачайте архив и **распакуйте в корень вашего репозитория**, рядом с `bot/`, `handlers/`, `alembic/` и т.д.
   - Важно: чтобы `sitecustomize.py` лежал **в корне**, который оказывается в `PYTHONPATH` при запуске.
2. Перезапустите бота (Railway перезапустит контейнер после деплоя в `main`).
3. Проверьте:
   - Текстовые сообщения: команда/сообщение должно отвечать, ошибка `NameError: embed_query is not defined` исчезнет.
   - Голос: обработчик больше не упадёт на той же причине.
4. Если у вас уже был свой `sitecustomize.py`, **объедините** его с текущим: добавьте строчку импорта `services.missing_impl`.

## Как это работает

- `services/missing_impl.py` пытается использовать ваш существующий `openai_helper`:
  - `await openai_helper.embed([text])` — для эмбеддингов.
  - `await openai_helper.chat([...])` — для ответов модели.
- Если `openai_helper` недоступен, подключается **безопасный фолбек**, чтобы бот **не падал** (но качество эмбеддингов/ответов будет ниже).
- `_build_prompt` формирует простой RAG‑промпт из ваших чанков (`content`/`text`/`page_content`) + вопрос пользователя.

## Что мы сознательно **не трогали**

- Логику скачивания аудио и распознавания (Whisper и т.п.).
- Настройки моделей/ключей/переменных окружения — всё остаётся как у вас.
- Структуру проекта и импортов.

## Частые вопросы

**Q: А если позже вы добавите “родные” реализации этих функций?**  
A: Просто удалите `sitecustomize.py` и папку `services/` или оставьте — они никому не мешают. При наличии ваших реализаций можно быстро переехать, заменив вызовы.

**Q: Это точно безопасно для Railway?**  
A: Да, Python по умолчанию грузит `sitecustomize.py`. Если по какой‑то причине у вас используется опция `-S` (отключение `site`), надо добавить явный импорт `import services.missing_impl` в самом раннем месте (например, в `bot/main.py`).

Удачи! Если захотите — расширю `_build_prompt` под ваш стиль, подключу историю и источники цитат.
