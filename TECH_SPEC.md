# TECH\_SPEC ‚Äî Telegram‚Äë–±–æ—Ç —Å OpenAI, **RAG –Ω–∞ PostgreSQL + PGVector** –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–æ–º

> –í–µ—Ä—Å–∏—è: **v1.1 (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-08-10)**\
> –¶–µ–ª—å: –µ–¥–∏–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –±–æ—Ç–∞ —Å –Ω—É–ª—è.

---

## 1) –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

Telegram‚Äë–±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Å —É—á—ë—Ç–æ–º –≤–Ω–µ—à–Ω–µ–π **–ë–∞–∑—ã –∑–Ω–∞–Ω–∏–π (–ë–ó)**, –ª–µ–∂–∞—â–µ–π –Ω–∞ **–Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ**. –¢–µ–∫—Å—Ç—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ **PostgreSQL** —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º **PGVector** –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (RAG). –ë–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å (—Ç–µ–∫—Å—Ç, –≥–æ–ª–æ—Å, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è), –º–Ω–æ–≥–æ–¥–∏–∞–ª–æ–≥–æ–≤–æ—Å—Ç—å, —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Å—Ç—Ä–æ–≥—É—é —Å–∏—Å—Ç–µ–º—É –¥–æ—Å—Ç—É–ø–∞ (–∞–¥–º–∏–Ω—ã/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏/–≥–æ—Å—Ç–∏).

---

## 2) –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è (–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è)

```
User ‚îÄ‚îÄ> Telegram API ‚îÄ‚îÄ> python‚Äëtelegram‚Äëbot ‚îÄ‚îÄ> ChatGPTTelegramBot
                                          ‚îÇ
                                          ‚îú‚îÄ> OpenAI (chat, embeddings, images, whisper)
                                          ‚îÇ
                                          ‚îú‚îÄ> –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ API (—Å–ø–∏—Å–æ–∫/—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤)
                                          ‚îÇ
                                          ‚îî‚îÄ> PostgreSQL + PGVector (–¥–∏–∞–ª–æ–≥–∏, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ë–ó, —á–∞–Ω–∫–∏, —ç–º–±–µ–¥–¥–∏–Ω–≥–∏)
```

### 2.1 –ú–æ–¥—É–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞

- **main.py** ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫, –ª–æ–≥–æ–≤, –ë–î, –∑–∞–ø—É—Å–∫ polling; —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤.
- **bot/telegram\_bot.py** ‚Äî –∫–ª–∞—Å—Å `ChatGPTTelegramBot`: –∫–æ–º–∞–Ω–¥—ã, callbacks, on\_error.
- **bot/openai\_helper.py** ‚Äî –∫–ª–∏–µ–Ω—Ç—ã –∏ –æ–±—ë—Ä—Ç–∫–∏ –¥–ª—è Chat Completions, Embeddings, Whisper, Image gen.
- **bot/knowledge\_base/**
  - `indexer.py` ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–æ–º, –ø–∞—Ä—Å–∏–Ω–≥, —á–∞–Ω–∫–æ–≤–∞–Ω–∏–µ, –ø–æ–¥—Å—á—ë—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤, –∑–∞–ø–∏—Å—å –≤ PGVector.
  - `retriever.py` ‚Äî –ø–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ (similarity search), —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
- **bot/yandex\_client.py** / **bot/yandex\_rest.py** ‚Äî —Ä–∞–±–æ—Ç–∞ —Å API –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞ (–ª–∏—Å—Ç–∏–Ω–≥, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ, HEAD/etag).
- **bot/dialog\_manager.py** ‚Äî –¥–∏–∞–ª–æ–≥–∏/—Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (CRUD –≤ –ë–î), —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞.
- **bot/db/** ‚Äî SQLAlchemy –º–æ–¥–µ–ª–∏, —Å–µ—Å—Å–∏–∏, –º–∏–≥—Ä–∞—Ü–∏–∏ (Alembic), —Ö–µ–ª–ø–µ—Ä—ã.
- **bot/settings.py** ‚Äî Pydantic‚Äë–Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —á—Ç–µ–Ω–∏–µ env, –≤–∞–ª–∏–¥–∞—Ü–∏—è.
- **bot/utils/** ‚Äî –æ–±—â–µ–µ: chunking, pdf/docx/xlsx/pptx –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞, —Ç–æ–∫–µ–Ω–∞–π–∑–µ—Ä, —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥, —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å —Ü–∏—Ç–∞—Ç–∞–º–∏.

---

## 3) –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (env)

| –ò–º—è                      | –¢–∏–ø | –û–±—è–∑. | –ü—Ä–∏–º–µ—Ä                       | –û–ø–∏—Å–∞–Ω–∏–µ                                           |
| ------------------------ | --- | ----- | ---------------------------- | -------------------------------------------------- |
| TELEGRAM\_BOT\_TOKEN     | str | ‚úî     | 12345\:ABC                   | –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞                                |
| OPENAI\_API\_KEY         | str | ‚úî     | sk‚Äë...                       | API‚Äë–∫–ª—é—á OpenAI                                    |
| OPENAI\_MODEL            | str | ‚úî     | gpt‚Äë4o‚Äëmini                  | –ú–æ–¥–µ–ª—å —á–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é                           |
| OPENAI\_IMAGE\_MODEL     | str | ‚úî     | dall‚Äëe‚Äë3                     | –ú–æ–¥–µ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π                       |
| OPENAI\_EMBEDDING\_MODEL | str | ‚úî     | text‚Äëembedding‚Äë3‚Äëlarge       | –ú–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –¥–ª—è PGVector                    |
| DATABASE\_URL            | str | ‚úî     | postgresql://u\:p\@h:5432/db | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL                           |
| YANDEX\_DISK\_TOKEN      | str | ‚úî     | y0\_AgAAA...                 | OAuth —Ç–æ–∫–µ–Ω –Ø.–î–∏—Å–∫–∞                                |
| YANDEX\_ROOT\_PATH       | str | ‚úî     | /KnowledgeBase               | –ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞ –ë–ó –Ω–∞ –¥–∏—Å–∫–µ                         |
| ADMIN\_USER\_IDS         | str | ‚úî     | 111,222                      | CSV id –∞–¥–º–∏–Ω–æ–≤                                     |
| ALLOWED\_USER\_IDS       | str | ‚úñ     | 333,444                      | CSV id —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) |
| CHUNK\_SIZE              | int | ‚úñ     | 1200                         | –î–ª–∏–Ω–∞ —á–∞–Ω–∫–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö                             |
| CHUNK\_OVERLAP           | int | ‚úñ     | 200                          | –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ —á–∞–Ω–∫–æ–≤                                  |
| KB\_TOP\_K               | int | ‚úñ     | 5                            | –°–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ —Ç–∞—â–∏–º –≤ prompt                      |
| MAX\_CONTEXT\_TOKENS     | int | ‚úñ     | 6000                         | –ë—é–¥–∂–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–ó                   |
| LOG\_LEVEL               | str | ‚úñ     | INFO                         | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è                                |
| RATE\_LIMIT\_PER\_MIN    | int | ‚úñ     | 20                           | –ê–Ω—Ç–∏—Å–ø–∞–º –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                           |

---

## 4) –î–∞–Ω–Ω—ã–µ –∏ –ë–î (PostgreSQL + PGVector)

–ò—Å–ø–æ–ª—å–∑—É–µ–º **pgvector** (`CREATE EXTENSION IF NOT EXISTS vector;`). –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–æ–¥–µ–ª–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3072 –¥–ª—è `text-embedding-3-large`).

### 4.1 –¢–∞–±–ª–∏—Ü—ã (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤)

- **users**: `id (pk)`, `tg_user_id (unique)`, `is_admin bool`, `is_allowed bool`, `lang`, `created_at`.
- **dialogs**: `id (pk)`, `user_id (fk users)`, `title`, `style`, `model`, `is_deleted`, `created_at`, `last_message_at`.
- **messages**: `id (pk)`, `dialog_id (fk dialogs)`, `role` (user/assistant/system), `content`, `tokens`, `created_at`.
- **kb\_documents**: `id (pk)`, `path` (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –Ω–∞ –Ø.–î–∏—Å–∫–µ), `etag`, `mime`, `pages`, `bytes`, `updated_at`, `is_active`.
- **kb\_chunks**: `id (pk)`, `document_id (fk kb_documents)`, `chunk_index`, `content`, `meta` (json: —Å—Ç—Ä–∞–Ω–∏—Ü–∞/—Å–ª–∞–π–¥/—è—á–µ–π–∫–∞), `embedding vector(3072)`.
- **dialog\_kb\_links**: `id (pk)`, `dialog_id (fk)`, `document_id (fk)`, `created_at` (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–æ–∫–∞ –∫ –¥–∏–∞–ª–æ–≥—É).
- **pdf\_passwords**: `id (pk)`, `dialog_id (fk)`, `document_id (fk)`, `pwd_hash` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), `created_at`.
- **audit\_log**: `id`, `user_id`, `event`, `payload jsonb`, `created_at` (–¥–ª—è –≤–∞–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π: grant/revoke, sync, purge).

–ò–Ω–¥–µ–∫—Å—ã: `kb_chunks using ivfflat (embedding vector_cosine_ops)`; B‚ÄëTree –Ω–∞ `path`, `dialog_id`, `user_id`.

### 4.2 –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ–±—ä—ë–º—ã

- –ß–∏—Å–ª–æ —á–∞–Ω–∫–æ–≤ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä 200‚Äì5‚ÄØ000 (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞).
- –ñ—ë—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç `MAX_CONTEXT_TOKENS`: –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π —á–∞–Ω–∫–æ–≤ –≤ prompt, –æ–±—Ä–µ–∑–∞–µ–º –ø–æ —Ç–æ–∫–µ–Ω–∞–º.

---

## 5) –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–ó (Indexer)

**–¢—Ä–∏–≥–≥–µ—Ä—ã:** `/kb_sync` (–∞–¥–º–∏–Ω), –∏–ª–∏ cron/interval –∑–∞ —Å—á—ë—Ç —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Ä—É—á–Ω—É—é).

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏–∑ `YANDEX_ROOT_PATH` (–ø–ª–æ—Å–∫–∏–π/—Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ–º–æ).
2. –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø–∞–º: `.pdf` (–≤ —Ç.—á. –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ), `.docx`, `.xlsx`, `.pptx`, `.txt`, `.csv`.
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞:
   - –°–≤–µ—Ä—è–µ–º `etag` (–∏–ª–∏ last‚Äëmodified/size) —Å —Ç–µ–º, —á—Ç–æ —É –Ω–∞—Å –≤ `kb_documents`.
   - –ï—Å–ª–∏ –Ω–æ–≤—ã–π/–∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí —Å–∫–∞—á–∏–≤–∞–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É, –ø–∞—Ä—Å–∏–º (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–æ–ª–µ–π –¥–ª—è PDF ‚Äî **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –¥–∏–∞–ª–æ–≥—É**, –ø–∞—Ä–æ–ª—å –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
   - –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç (—É–¥–∞–ª—è–µ–º –º—É—Å–æ—Ä, –ø–µ—Ä–µ–Ω–æ—Å—ã, –º–Ω–æ–≥–æ –ø—Ä–æ–±–µ–ª–æ–≤), —Ä–µ–∂–µ–º –Ω–∞ —á–∞–Ω–∫–∏ (`CHUNK_SIZE` + `CHUNK_OVERLAP`).
   - –°—á–∏—Ç–∞–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –Ω–∞ **OpenAI\_EMBEDDING\_MODEL** (–±–∞—Ç—á–∞–º–∏, —Å —Ä–µ—Ç—Ä–∞—è–º–∏).
   - –ü–∏—à–µ–º —á–∞–Ω–∫–∏ –≤ `kb_chunks` –∏ –¥–æ–∫—É–º–µ–Ω—Ç/–º–µ—Ç–∞–¥–∞—Ç—É –≤ `kb_documents` (upsert).
4. –î–ª—è —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –Ω–∞ –î–∏—Å–∫–µ —Ñ–∞–π–ª–æ–≤ ‚Äî **—Å—Ç–∞–≤–∏–º **``; –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ —Ç–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –≤—ã–¥–∞—á–µ.

**–û—à–∏–±–∫–∏/—Ä–µ—Ç—Ä–∞–∏:** —Å–µ—Ç—å, 5xx –æ—Ç API, timeouts ‚Üí —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, –∑–∞–ø–∏—Å—å –≤ `audit_log`.

---

## 6) –ü–æ–∏—Å–∫ –∏ –≤—Å—Ç–∞–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (Retriever, RAG)

**–í—Ö–æ–¥:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å + —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∫ –¥–∏–∞–ª–æ–≥—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.\
**–®–∞–≥–∏:**

1. –°—á–∏—Ç–∞–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞ (`embedding(model=OPENAI_EMBEDDING_MODEL)`).
2. –î–æ—Å—Ç–∞—ë–º top‚ÄëK —á–∞–Ω–∫–æ–≤ –∏–∑ `kb_chunks` –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º, –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–º –∫ –¥–∏–∞–ª–æ–≥—É:\
   `SELECT ... ORDER BY embedding <=> :query_vec LIMIT :KB_TOP_K` (cosine/inner product).
3. –§–æ—Ä–º–∏—Ä—É–µ–º **–∫–æ–Ω—Ç–µ–∫—Å—Ç** (concatenate), —Å–æ–±–ª—é–¥–∞—è `MAX_CONTEXT_TOKENS` (—Å–Ω–∞—á–∞–ª–∞ —Å–∞–º—ã–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ, –∑–∞—Ç–µ–º –º–µ–Ω–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω—è–µ–º rerank).
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º **–ø—Ä–æ–º–ø—Ç** —Å —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π + –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞ + **–∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏–∑ –ë–ó**.
5. –ó–∞–ø—É—Å–∫–∞–µ–º Chat Completion –Ω–∞ `OPENAI_MODEL`.
6. –í –æ—Ç–≤–µ—Ç **–≤–∫–ª—é—á–∞–µ–º —Ü–∏—Ç–∞—Ç—ã** (–∫–æ—Ä–æ—Ç–∫–∏–µ –≤—ã–¥–µ—Ä–∂–∫–∏) –∏ **–∏—Å—Ç–æ—á–Ω–∏–∫–∏** (–∏–º—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ + –ª–æ–∫–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã/—Å–ª–∞–π–¥–∞/—è—á–µ–π–∫–∏).
7. –õ–æ–≥–∏—Ä—É–µ–º —Ñ–∞–∫—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–¥–ª—è –¥–µ–±–∞–≥–∞ –∫–∞—á–µ—Å—Ç–≤–∞).

**–í–∞–∂–Ω–æ:**

- –ï—Å–ª–∏ –ë–ó **–≤—ã–∫–ª—é—á–µ–Ω–∞** –≤ –¥–∞–Ω–Ω–æ–º –¥–∏–∞–ª–æ–≥–µ ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–∞—Ç –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
- –ï—Å–ª–∏ –ë–ó –≤–∫–ª—é—á–µ–Ω–∞, –Ω–æ **–Ω–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤** ‚Äî —á–µ—Å—Ç–Ω–æ –≥–æ–≤–æ—Ä–∏–º –æ–± —ç—Ç–æ–º –∏ –æ—Ç–≤–µ—á–∞–µ–º –±–µ–∑ ¬´–≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π¬ª.

---

## 7) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∏ —Ä–æ–ª—è–º–∏

- **–ê–¥–º–∏–Ω—ã**: –∑–∞–¥–∞–Ω—ã —á–µ—Ä–µ–∑ `ADMIN_USER_IDS` –∏/–∏–ª–∏ –ø–æ–º–µ—á–µ–Ω—ã –≤ `users.is_admin=true`.
- **–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**:
  - –µ—Å–ª–∏ `ALLOWED_USER_IDS` –ø—É—Å—Ç–æ ‚Äî **—Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ–º**;
  - –∏–Ω–∞—á–µ ‚Äî –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Ç–µ–º, —á—å–∏ id –≤ —Å–ø–∏—Å–∫–µ –∏–ª–∏ `users.is_allowed=true`.
- **–ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω):**
  - `/grant <tg_id>` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `users` –∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å `is_allowed=true`.
  - `/revoke <tg_id>` ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç—å `is_allowed=false`.
  - `/whoami` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ü—Ä–∏ –ª—é–±–æ–º –∞–ø–¥–µ–π—Ç–µ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω ‚Üí –≤–µ–∂–ª–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ª–æ–≥ –≤ `audit_log`.

---

## 8) –ö–æ–º–∞–Ω–¥—ã –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–¥–µ—Ç–∞–ª—å–Ω–æ)

### 8.1 –û–±—â–∏–µ

- `/start` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞; –∫—Ä–∞—Ç–∫–∞—è –ø–∞–º—è—Ç–∫–∞.
- `/help` ‚Äî –∫—Ä–∞—Ç–∫–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏; –ø–∞–≥–∏–Ω–∞—Ü–∏—è —á–µ—Ä–µ–∑ inline‚Äë–∫–Ω–æ–ø–∫–∏.
- `/reset` ‚Äî —Å–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ (–∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è: –æ–∂–∏–¥–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è, –≤—ã–±–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞).
- `/stats` ‚Äî –∫–æ–ª‚Äë–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤, —Å–æ–æ–±—â–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–ø–æ –∂–µ–ª–∞–Ω–∏—é) –∏ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

### 8.2 –î–∏–∞–ª–æ–≥–∏

- `/dialogs` ‚Äî —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ (inline‚Äë–∫–Ω–æ–ø–∫–∏: –æ—Ç–∫—Ä—ã—Ç—å, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å, —ç–∫—Å–ø–æ—Ä—Ç `.md`, —É–¥–∞–ª–∏—Ç—å).
- `/dialog <id>` ‚Äî —Å–¥–µ–ª–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º.
- –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è: `YYYY‚ÄëMM‚ÄëDD | <–ø–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞ –≤–æ–ø—Ä–æ—Å–∞>`.
- –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –≤ `.md` (–≤—Å—Ç–∞–≤–ª—è—Ç—å —Ü–∏—Ç–∞—Ç—ã/–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).

### 8.3 –ú–æ–¥–µ–ª—å –∏ —Å—Ç–∏–ª—å

- `/model` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏–∑ OpenAI API (list), –≤—ã–±–æ—Ä inline‚Äë–∫–Ω–æ–ø–∫–∞–º–∏, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `dialogs.model`.
- `/mode` ‚Äî —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞: `ceo`, `expert`, `pro`, `user` (—Å–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –º–µ–Ω—è–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, —Ö—Ä–∞–Ω–∏—Ç—å –≤ `dialogs.style`).

### 8.4 KB (–Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫)

- `/kb` ‚Äî –º–µ–Ω—é:
  - **–í—ã–±—Ä–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã** (–ø–∞–≥–∏–Ω–∞—Ü–∏—è, —á–µ–∫–±–æ–∫—Å—ã)
  - **–ú–æ–∏ –≤ –¥–∏–∞–ª–æ–≥–µ** (—Å–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö + —Å–Ω—è—Ç–∏–µ)
  - **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/—Å–Ω—è—Ç–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å—é/—É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ `dialog_kb_links`.
- –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç `.pdf` –∏ –∑–∞—â–∏—â—ë–Ω ‚Äî –±–æ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–∞—Ä–æ–ª—å **–ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏**, —Ö—Ä–∞–Ω–∏—Ç –≤ `pdf_passwords` **—Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞** (–º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ö–µ—à/—à–∏—Ñ—Ä).

### 8.5 –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ë–ó

- `/kb_diag` (–∞–¥–º–∏–Ω): –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤/—á–∞–Ω–∫–æ–≤; —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏; orphan‚Äë—á–∞–Ω–∫–∏; dangle‚Äëlinks; –Ω–∞–ª–∏—á–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –¥–∏–∞–ª–æ–≥–∞–º.

### 8.6 –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≥–æ–ª–æ—Å

- `/img <prompt>` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ `OPENAI_IMAGE_MODEL`, –æ—Ç–¥–∞—ë–º –∫–∞–∫ —Ñ–æ—Ç–æ.
- **–ì–æ–ª–æ—Å**: –ø—Ä–∏ `voice`‚Äë—Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî —Å–∫–∞—á–∏–≤–∞–µ–º `ogg`, —à–ª—ë–º –≤ Whisper ‚Üí —Ç–µ–∫—Å—Ç; –¥–∞–ª–µ–µ –æ–±—ã—á–Ω—ã–π RAG –æ—Ç–≤–µ—Ç.

### 8.7 –í–µ–±‚Äë–ø–æ–∏—Å–∫

- `/web <–∑–∞–ø—Ä–æ—Å>` ‚Äî –ø–æ–∏—Å–∫ –ø–æ –≤–Ω–µ—à–Ω–µ–º—É API (Bing/SerpAPI): –∫–æ—Ä–æ—Ç–∫–∏–π –¥–∞–π–¥–∂–µ—Å—Ç + –∏—Å—Ç–æ—á–Ω–∏–∫–∏.
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å ¬´–≤–∫–ª—é—á–∏—Ç—å –≤–µ–±‚Äë–ø–æ–∏—Å–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é¬ª ‚Äî —Ñ–ª–∞–≥ –≤ state –¥–∏–∞–ª–æ–≥–∞.

---

## 9) –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ (prompting)

**–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∏–ª–µ–º `/mode`), –¥–∞–ª–µ–µ:

- **–ò—Å—Ç–æ—Ä–∏—è** –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–æ–æ–±—â–µ–Ω–∏–π (N –ø–æ –±—é–¥–∂–µ—Ç—É —Ç–æ–∫–µ–Ω–æ–≤, –Ω–∞–ø—Ä. 6‚Äì10).
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–ó** (—á–∞–Ω–∫–∏ —Å —Ü–∏—Ç–∞—Ç–∞–º–∏, `KB_TOP_K`, —Å–æ–±–ª—é–¥–∞–µ–º `MAX_CONTEXT_TOKENS`).
- **–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:**

- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –ë–ó ‚Äî –ø—Ä–∏–≤–µ—Å—Ç–∏ 2‚Äì5 —Ü–∏—Ç–∞—Ç —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ **–ò—Å—Ç–æ—á–Ω–∏–∫**: `–î–æ–∫—É–º–µ–Ω—Ç (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ X / —Å–ª–∞–π–¥ Y / –ª–∏—Å—Ç Z)`.
- –ï—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å —ç—Ç–æ –∏ –Ω–µ –≥–∞–ª–ª—é—Ü–∏–Ω–∏—Ä–æ–≤–∞—Ç—å.

---

## 10) –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

- **–ì–ª–æ–±–∞–ª—å–Ω—ã–π **``: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ stacktrace, –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ¬´—á—Ç–æ‚Äë—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫¬ª, –Ω–µ –ø–∞–¥–∞–µ–º.
- **–†–µ—Ç—Ä–∞–∏** –Ω–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö (OpenAI, –Ø.–î–∏—Å–∫) —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –ø–∞—É–∑–æ–π.
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (mimetype/—Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞, –ø—É—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã, timeouts).
- –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥: `RATE_LIMIT_PER_MIN` –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (in‚Äëmemory/Redis/DB —Å—á—ë—Ç—á–∏–∫–∏).

---

## 11) Railway: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

- Python 3.11, `psycopg2-binary`, `sqlalchemy`, `pgvector`, `python-telegram-bot==20.*`.
- `WEBHOOK` –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º `run_polling()` (–ø—Ä–æ—â–µ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞).
- –õ–æ–≥–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `INFO`. –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ ‚Äî `DEBUG` (–º–æ–∂–µ—Ç —Å—Ç–æ–∏—Ç—å –¥–µ–Ω–µ–≥ –Ω–∞ OpenAI –∏–∑‚Äë–∑–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π; –≤–∫–ª—é—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω–æ).
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤ PostgreSQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `pgvector` –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã `ivfflat`.

---

## 12) Security & Privacy

- –ù–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª–∏ –∫ PDF –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ (–º–∏–Ω–∏–º—É–º: —Ö–µ—à; –ª—É—á—à–µ ‚Äî —à–∏—Ñ—Ä —Å –∫–ª—é—á–æ–º –∏–∑ env).
- –°–µ–∫—Ä–µ—Ç—ã —Ç–æ–ª—å–∫–æ –≤ env, –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—å.
- –õ–æ–≥–∏ –±–µ–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤).

---

## 13) –ü–ª–∞–Ω —Ä–∞–±–æ—Ç (–∏—Ç–µ—Ä–∞—Ü–∏–∏)

**–ò—Ç–µ—Ä–∞—Ü–∏—è 1 (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞):** –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î, pgvector, –±–∞–∑–æ–≤—ã–µ –º–æ–¥–µ–ª–∏, DialogManager, settings, on\_error.\
**–ò—Ç–µ—Ä–∞—Ü–∏—è 2 (–Ø.–î–∏—Å–∫ + –∏–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä):** —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è, –ø–∞—Ä—Å–µ—Ä—ã, —á–∞–Ω–∫–æ–≤–∞–Ω–∏–µ, —ç–º–±–µ–¥–¥–∏–Ω–≥–∏, –∑–∞–ø–∏—Å—å –≤ PGVector.\
**–ò—Ç–µ—Ä–∞—Ü–∏—è 3 (RAG‚Äë–æ—Ç–≤–µ—Ç—ã):** retriever, –±—é–¥–∂–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤, —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å—Ç–∏–ª–∏ `/mode`.\
**–ò—Ç–µ—Ä–∞—Ü–∏—è 4 (UI –≤ TG):** `/kb` —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π, ¬´–º–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã¬ª, –ø–∞—Ä–æ–ª–∏ –∫ PDF, `/kb_diag`, `/dialogs`.\
**–ò—Ç–µ—Ä–∞—Ü–∏—è 5 (–ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å):** `/img`, –≥–æ–ª–æ—Å, `/web`, —ç–∫—Å–ø–æ—Ä—Ç –¥–∏–∞–ª–æ–≥–∞.\
**–ò—Ç–µ—Ä–∞—Ü–∏—è 6 (–î–æ—Å—Ç—É–ø –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å):** `/grant`, `/revoke`, `/whoami`, audit\_log, —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥.\
**–ò—Ç–µ—Ä–∞—Ü–∏—è 7 (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è):** –∏–Ω–¥–µ–∫—Å—ã, –±–∞—Ç—á–∏–Ω–≥–∏, –∫—ç—à —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ç–æ–∫–µ–Ω–∞–º.

---

## 14) –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è)

1. –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `YANDEX_ROOT_PATH` —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∏–ª–∏ —Ç–æ–ª—å–∫–æ 1 —É—Ä–æ–≤–µ–Ω—å?
2. –§–æ—Ä–º–∞—Ç —Ü–∏—Ç–∞—Ç/—Å—Å—ã–ª–æ–∫ –≤ –æ—Ç–≤–µ—Ç–∞—Ö (—Ç–æ–ª—å–∫–æ –∏–º—è —Ñ–∞–π–ª–∞ + —Å—Ç—Ä–∞–Ω–∏—Ü–∞? –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª –≤ –Ø.–î–∏—Å–∫–µ?).
3. –†–∞–∑–º–µ—Ä –æ–∫–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ —Ç–æ–∫–µ–Ω–∞–º/–ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏).
4. –ù—É–∂–Ω–∞ –ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ä–æ–ª—å ¬´–º–æ–¥–µ—Ä–∞—Ç–æ—Ä¬ª (—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä `/kb_diag`, –±–µ–∑ `/grant`/`/revoke`)?

---

## 15) –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ø—Å–µ–≤–¥–æ‚ÄëSQL –¥–ª—è PGVector

```sql
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE kb_documents (
  id BIGSERIAL PRIMARY KEY,
  path TEXT UNIQUE NOT NULL,
  etag TEXT,
  mime TEXT,
  pages INT,
  bytes BIGINT,
  updated_at TIMESTAMPTZ DEFAULT now(),
  is_active BOOLEAN DEFAULT TRUE
);

-- –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –ø–æ–¥–±–µ—Ä–∏—Ç–µ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
CREATE TABLE kb_chunks (
  id BIGSERIAL PRIMARY KEY,
  document_id BIGINT REFERENCES kb_documents(id) ON DELETE CASCADE,
  chunk_index INT NOT NULL,
  content TEXT NOT NULL,
  meta JSONB,
  embedding VECTOR(3072)
);

CREATE INDEX ON kb_chunks (document_id);
CREATE INDEX kb_chunks_embedding_idx ON kb_chunks USING ivfflat (embedding vector_cosine_ops);
```

---

**–ì–æ—Ç–æ–≤–æ.** –≠—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Å —É—á—ë—Ç–æ–º **PGVector** –∏ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–µ–¥–ª–∞–≥–∞—é –¥–∞–ª—å—à–µ:

- –¥–æ–±–∞–≤–∏—Ç—å ER‚Äë–¥–∏–∞–≥—Ä–∞–º–º—É –∏ Alembic‚Äë–º–∏–≥—Ä–∞—Ü–∏–∏,
- –æ–ø–∏—Å–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ (—à–∞–±–ª–æ–Ω—ã —Ç–µ–∫—Å—Ç–æ–≤ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã),
- –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ OpenAI (production/backup).



---

## 16) ER‚Äë–¥–∏–∞–≥—Ä–∞–º–º–∞ (ASCII)

```
users (id PK) ‚îÄ‚îÄ‚îê
                ‚îÇ 1..N
dialogs (id PK, user_id FK -> users.id)
   ‚îÇ 1..N
   ‚îî‚îÄ‚îÄ messages (id PK, dialog_id FK)

kb_documents (id PK)
   ‚îÇ 1..N
   ‚îî‚îÄ‚îÄ kb_chunks (id PK, document_id FK)

dialogs (id) 1..N ‚îÄ‚îÄ dialog_kb_links (id PK, dialog_id FK, document_id FK) N..1 ‚îÄ‚îÄ kb_documents (id)

dialogs (id) 1..N ‚îÄ‚îÄ pdf_passwords (id PK, dialog_id FK, document_id FK) N..1 ‚îÄ‚îÄ kb_documents (id)

users (id) 1..N ‚îÄ‚îÄ audit_log (id PK, user_id FK)
```

---

## 17) Alembic: —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –º–∏–≥—Ä–∞—Ü–∏–π

**env.py**: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω –ø–æ–¥ SQLAlchemy + DATABASE\_URL –∏–∑ env.\
**versions/**:

- `0001_init_core.py`
  - `users`, `dialogs`, `messages`.
- `0002_kb_pgvector.py`
  - `CREATE EXTENSION IF NOT EXISTS vector;`
  - `kb_documents`, `kb_chunks (VECTOR(3072))`, –∏–Ω–¥–µ–∫—Å `ivfflat`.
- `0003_dialog_kb_links_passwords.py`
  - `dialog_kb_links`, `pdf_passwords`.
- `0004_audit_log.py`
  - `audit_log`.

**–ü—Ä–∏–º–µ—Ä up() –¥–ª—è 0002:**

```python
from alembic import op
import sqlalchemy as sa


def upgrade():
    op.execute("CREATE EXTENSION IF NOT EXISTS vector;")
    op.create_table(
        'kb_documents',
        sa.Column('id', sa.BigInteger, primary_key=True),
        sa.Column('path', sa.Text, nullable=False, unique=True),
        sa.Column('etag', sa.Text),
        sa.Column('mime', sa.Text),
        sa.Column('pages', sa.Integer),
        sa.Column('bytes', sa.BigInteger),
        sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()')),
        sa.Column('is_active', sa.Boolean, server_default=sa.text('true')),
    )
    op.create_table(
        'kb_chunks',
        sa.Column('id', sa.BigInteger, primary_key=True),
        sa.Column('document_id', sa.BigInteger, sa.ForeignKey('kb_documents.id', ondelete='CASCADE')),
        sa.Column('chunk_index', sa.Integer, nullable=False),
        sa.Column('content', sa.Text, nullable=False),
        sa.Column('meta', sa.JSON),
        sa.Column('embedding', sa.dialects.postgresql.VECTOR(dim=3072)),
    )
    op.create_index('ix_kb_chunks_document_id', 'kb_chunks', ['document_id'])
    op.execute("CREATE INDEX kb_chunks_embedding_idx ON kb_chunks USING ivfflat (embedding vector_cosine_ops);")


def downgrade():
    op.execute('DROP INDEX IF EXISTS kb_chunks_embedding_idx;')
    op.drop_index('ix_kb_chunks_document_id', table_name='kb_chunks')
    op.drop_table('kb_chunks')
    op.drop_table('kb_documents')
```

> ‚ö†Ô∏è –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Alembic <1.12, —Ç–∏–ø VECTOR –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π TypeDecorator.

---

## 18) –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä

### 18.1 –û–±—â–∏–µ —Ç–µ–∫—Å—Ç—ã

- **–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ**: `–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –∏—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –∏–∑ –ë–∞–∑—ã –∑–Ω–∞–Ω–∏–π. –ù–∞–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ /kb.`
- **–û—Ç–∫–∞–∑ –≤ –¥–æ—Å—Ç—É–ø–µ**: `–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á—ë–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.`
- **–°–±–æ–π**: `‚ö† –ß—Ç–æ‚Äë—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ.`
- **–ù–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤**: `–ü–æ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –Ω–µ –Ω–∞—à—ë–ª —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤. –ú–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –æ–±—â–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç–µ –≤–æ–ø—Ä–æ—Å.`

### 18.2 –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (/kb)

- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:\
  `[["üìö –í—ã–±—Ä–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã"], ["üóÇ –ú–æ–∏ –≤ –¥–∏–∞–ª–æ–≥–µ"], ["üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è"(—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)]]`
- –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—Å—Ç—Ä–∞–Ω–∏—Ü–∞):\
  `[["‚òê –î–æ–∫—É–º–µ–Ω—Ç 1"],["‚òê –î–æ–∫—É–º–µ–Ω—Ç 2"], ..., ["¬´ –ù–∞–∑–∞–¥", "–í–ø–µ—Ä—ë–¥ ¬ª"], ["üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å"], ["‚¨ÖÔ∏è –í –º–µ–Ω—é –ë–ó"]]`
- –ü–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ:\
  `[["–°–Ω—è—Ç—å: –î–æ–∫—É–º–µ–Ω—Ç 1"],..., ["‚¨ÖÔ∏è –í –º–µ–Ω—é –ë–ó"]]`

### 18.3 –î–∏–∞–ª–æ–≥–∏

- –°–ø–∏—Å–æ–∫: –∫–Ω–æ–ø–∫–∏ `–û—Ç–∫—Ä—ã—Ç—å | ‚úèÔ∏è | üì§ | üóëÔ∏è`.
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: `–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞:`.
- –≠–∫—Å–ø–æ—Ä—Ç: –æ—Ç–¥–∞—ë–º `.md` —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ –ø–æ—Ä—è–¥–∫–µ –≤—Ä–µ–º–µ–Ω–∏.

---

## 19) –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –∏ —Å—Ç–∏–ª–∏ `/mode`

### 19.1 –ë–∞–∑–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

```
–¢—ã ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –ø–æ —Å—É—Ç–∏. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (2‚Äì5 —Ü–∏—Ç–∞—Ç –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏). –ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ—Ç ‚Äî —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è.
```

### 19.2 –°—Ç–∏–ª–∏

- **ceo**: –∫—Ä–∞—Ç–∫–æ, —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–Ω–æ, —Ñ–æ–∫—É—Å –Ω–∞ —Ä–∏—Å–∫–∞—Ö –∏ —Ä–µ—à–µ–Ω–∏—è—Ö, 3‚Äì5 –±—É–ª–ª–µ—Ç–æ–≤, –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã –∑–∞ –º–∏–Ω–∏–º—É–º —Å–ª–æ–≤.
- **expert**: –≥–ª—É–±–æ–∫–æ, —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ü–∏—Ç–∞—Ç—ã, –ø—Ä–∏—á–∏–Ω—ã/—Å–ª–µ–¥—Å—Ç–≤–∏—è, —Ç–∞–±–ª–∏—á–∫–∏ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
- **pro**: —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ, —á—ë—Ç–∫–æ, —à–∞–≥–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è, —á–µ–∫‚Äë–ª–∏—Å—Ç—ã.
- **user**: –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –ø—Ä–∏–º–µ—Ä—ã, –∞–Ω–∞–ª–æ–≥–∏–∏.

**–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:**

```
–°—Ç–∏–ª—å: {style}. –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: {lang}. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã. –í –∫–æ–Ω—Ü–µ ‚Äî –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∏–∑ 1‚Äì2 —Å—Ç—Ä–æ–∫.
```

---

## 20) –ë—é–¥–∂–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞ prompt

- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞: –¥–æ 6‚Äì10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π **–∏–ª–∏** –ª–∏–º–∏—Ç –≤ 2‚ÄØ000‚Äì3‚ÄØ000 —Ç–æ–∫–µ–Ω–æ–≤.
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–ó: –¥–æ `MAX_CONTEXT_TOKENS` (–Ω–∞–ø—Ä. 6‚ÄØ000) ‚Äî –Ω–∞–±–∏—Ä–∞–µ–º top‚ÄëK —á–∞–Ω–∫–∏, –æ–±—Ä–µ–∑–∞–µ–º –ø–æ —Ç–æ–∫–µ–Ω–∞–º.
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å: –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
- –°–∏—Å—Ç–µ–º–∫–∞: —Ñ–∏–∫—Å.

> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —Å—á–∏—Ç–∞—Ç—å —Ç–æ–∫–µ–Ω—ã —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–æ–º tiktoken/–ø–æ –∞–Ω–∞–ª–æ–≥—É, –∏ ¬´—É–ø–ª–æ—Ç–Ω—è—Ç—å¬ª –¥–ª–∏–Ω–Ω—ã–µ —á–∞–Ω–∫–∏.

---

## 21) –ü—Å–µ–≤–¥–æ–∫–æ–¥ Retriever (postgres + pgvector)

```sql
-- query_embedding = embed(user_question)
SELECT c.content, c.meta, d.path
FROM kb_chunks c
JOIN kb_documents d ON d.id = c.document_id AND d.is_active
JOIN dialog_kb_links l ON l.document_id = d.id AND l.dialog_id = :dialog_id
ORDER BY c.embedding <=> :query_embedding
LIMIT :top_k;
```

–î–∞–ª–µ–µ ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞/–∞–≥—Ä–µ–≥–∞—Ü–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Python, —Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–æ –ª–∏–º–∏—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤.

---

## 22) –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞: —É—Ç–æ—á–Ω–µ–Ω–∏–µ

- –•—É–∫ ¬´–ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π update¬ª:\
  –ï—Å–ª–∏ `ALLOWED_USER_IDS` –ø—É—Å—Ç–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å–µ—Ö.\
  –ò–Ω–∞—á–µ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫—Ç–æ —É–∫–∞–∑–∞–Ω **–∏–ª–∏** —É–∂–µ –ø–æ–º–µ—á–µ–Ω `users.is_allowed=true`.
- –ö–æ–º–∞–Ω–¥—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤:
  - `/grant <tg_id>` ‚Üí `users.is_allowed=true` (—Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –Ω–µ—Ç).
  - `/revoke <tg_id>` ‚Üí `users.is_allowed=false`.
  - `/whoami` ‚Üí –≤—ã–≤–µ—Å—Ç–∏ `is_admin`, `is_allowed`, —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥, —Å—Ç–∏–ª—å, –º–æ–¥–µ–ª—å.

---

## 23) –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å Alembic‚Äë–º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ —à–∞–±–ª–æ–Ω–∞–º (–ø.17).
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `indexer.py` (–ø–æ—Ç–æ–∫–∏: list ‚Üí download ‚Üí parse ‚Üí chunk ‚Üí embed ‚Üí upsert).
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `retriever.py` (SQL + –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ —Ç–æ–∫–µ–Ω–∞–º).
4. –í–Ω–µ–¥—Ä–∏—Ç—å `/kb` UI (–ø–∞–≥–∏–Ω–∞—Ü–∏—è, –≤—ã–±–æ—Ä, ¬´–º–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã¬ª, –ø–∞—Ä–æ–ª–∏ PDF).
5. –ü–æ–¥–∫–ª—é—á–∏—Ç—å `/mode`, `/model`, `/dialogs`, —ç–∫—Å–ø–æ—Ä—Ç `.md`.
6. –î–æ–±–∞–≤–∏—Ç—å `/img`, –≥–æ–ª–æ—Å (Whisper), `/web`.

