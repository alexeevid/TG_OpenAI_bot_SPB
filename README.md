самопал
# TG_OpenAI_bot_SPB — Telegram-бот на OpenAI + PostgreSQL + База знаний (Yandex.Disk)

Проект: Telegram-бот на `python-telegram-bot v20` с диалогами, выбором модели/стиля ответа, голосовыми сообщениями, генерацией изображений и RAG по базе знаний, синхронизируемой через API Яндекс.Диска.

---

## Возможности

- **Диалоги**: создание/переключение/удаление/переименование, сохранение истории.
- **Режимы ответа** (`/mode`): стиль ответа (профессионал/тренер/… — зависит от конфигурации).
- **Выбор модели** (`/model`): выбор доступной text-модели OpenAI.
- **Текст**: обычные сообщения → ответ в текущем диалоге.
- **Голос**: голосовые сообщения → транскрибация → ответ в диалоге.
- **Изображения**:
  - команда `/draw <описание>`
  - а также триггер в тексте/голосе: **«нарисуй …» / «рисуй …» / «draw …»**
- **База знаний (RAG)**:
  - глобальный каталог документов на Яндекс.Диске
  - выбор документов для **текущего диалога**
  - поддержка защищённых PDF (пароль задаётся в рамках диалога)
- **Управление доступом** (админ): `/access` (allow/block/admin/list, UI-меню).
- **Web-поиск** (`/web`) — опционально (если включён провайдер и API-ключи).

---

## Команды бота

### Основные
- `/start` — старт/приветствие
- `/help` — справка
- `/reset` — начать новый диалог (сброс активного)
- `/dialogs` — управление диалогами (выбор/удаление/переименование)
- `/status` — статус текущего диалога (модель/режим/настройки БЗ)
- `/stats` — алиас для `/status`
- `/model` — выбрать модель
- `/mode` — выбрать стиль ответа
- `/draw <описание>` — генерация изображения

### База знаний (RAG)
Команда `/kb` включает набор подкоманд:

**Основное**
- `/kb` — справка и статус
- `/kb select` — выбрать документы для **текущего** диалога (UI)
- `/kb list` — список документов, подключённых к диалогу
- `/kb on | /kb off | /kb auto` — режим применения БЗ в диалоге (рекомендация: `auto`)

**Глобально**
- `/kb catalog [стр]` — каталог документов БЗ (пагинация)
- `/kb stats` — статистика БЗ (глобально)
- `/kb stats dialog` — статистика БЗ для текущего диалога

**Пароли для PDF (в рамках диалога)**
- `/kb password <doc_id> <пароль>`

**Админ (если настроен syncer)**
- `/kb scan`
- `/kb sync`
- `/kb status`

### Web-поиск (опционально)
- `/web <запрос>` — поиск в интернете (работает, если включено в env)

### Админ-доступы
- `/access` — управление доступом через UI-кнопки  
  (добавление/блокировка/удаление записей/назначение админов/список)

---

## Как пользоваться (коротко)

### Обычный чат
1) `/start`  
2) Пиши текст — бот отвечает в рамках активного диалога.  
3) `/reset` — новый диалог “с нуля”.

### Диалоги
- `/dialogs` → выбрать активный диалог, переименовать или удалить.

### Генерация изображений
- `/draw кот в скафандре на луне`
- или текстом/голосом: `нарисуй кот в скафандре на луне`

### База знаний
1) `/kb select` → выбрать документы для текущего диалога  
2) `/kb auto` → включить AUTO-режим (бот сам решает, когда применять БЗ)  
3) Пиши вопрос — бот будет подтягивать релевантные цитаты из выбранных документов.

Если документ PDF защищён паролем:
- `/kb password <doc_id> <пароль>`

---

## Архитектура (кратко)

- `app/main.py` — старт приложения, регистрация хендлеров, сборка сервисов
- `app/handlers/*` — Telegram-хендлеры команд/сообщений
- `app/services/*` — бизнес-логика (диалоги, генерация, голос, RAG, доступы)
- `app/db/*` — SQLAlchemy модели и репозитории
- `app/kb/*` — индексация, извлечение, синхронизация и RAG-компоненты
- `app/clients/*` — клиенты OpenAI, Яндекс.Диска, web-поиска

---

## Переменные окружения (env)

### Обязательные
- `TELEGRAM_BOT_TOKEN` — токен Telegram-бота
- `OPENAI_API_KEY` — ключ OpenAI
- `DATABASE_URL` — строка подключения PostgreSQL  
  Формат: `postgresql://user:pass@host:port/dbname`  
  (важно: **без** `+psycopg`)

### Яндекс.Диск (для БЗ)
- `YANDEX_DISK_TOKEN` — OAuth-токен Яндекс.Диска
- `YANDEX_ROOT_PATH` — корневая папка БЗ на диске (например `/KB`)

### Доступы / админы
- `ADMIN_USER_IDS` — список tg_id админов (через запятую), например: `123,456`
- `ADMIN_CHAT_ID` — (опционально) чат админов (в текущей логике используется ограниченно)
- `ALLOWED_USER_IDS` — (опционально) allow-лист пользователей, если используешь белый список

### Модели
- `OPENAI_TEXT_MODEL` — text-модель (или `OPENAI_MODEL` / `TEXT_MODEL`)
- `OPENAI_IMAGE_MODEL` — модель для картинок (по умолчанию `gpt-image-1`)
- `OPENAI_TRANSCRIBE_MODEL` — модель для транскрибации голоса (если используется)

### Web-поиск (опционально)
- `ENABLE_WEB_SEARCH` — `true/false`
- `WEB_SEARCH_PROVIDER` — провайдер (если поддерживается)
- `TAVILY_API_KEY` — ключ Tavily (если выбран)

### RAG-параметры (опционально)
- `CHUNK_SIZE` — размер чанка (по умолчанию 900)
- `CHUNK_OVERLAP` — перекрытие (по умолчанию 150)
- `MAX_KB_CHUNKS` — максимум чанков в контексте (по умолчанию 6)
- `KB_DEBUG` — `true/false`
- `KB_SYNC_ENTRYPOINT` — включение/маршрут sync-процедуры (если используется)
- `KB_SYNC_INTERVAL` — интервал синхронизации (если используется)

### Логи / лимиты
- `LOG_LEVEL` — `DEBUG/INFO/...`
- `RATE_LIMIT_PER_MIN` — лимит запросов на пользователя в минуту (по умолчанию 60)

---

## Установка и запуск локально

### 1) Установить зависимости
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
