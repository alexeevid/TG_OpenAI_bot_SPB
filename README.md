# Telegram RAG-бот (OpenAI + База знаний)

## Возможности
- Текстовый и голосовой диалог (стабильное STT через `whisper-1`).
- База знаний (RAG): выбор документов, автосинхронизация, извлечение контекста из выбранных документов.
- Генерация изображений (`/img`) — `dall-e-3` с fallback на `gpt-image-1`, поддержка base64 и url.
- Веб-поиск (`/web`) — DuckDuckGo (html endpoint) + список ссылок.
- Мульти-диалоги: создание/переключение/удаление.
- Выбор модели и стиля ответа.

## Команды
- `/start` — приветствие.
- `/help` — справка.
- `/reset` — новый диалог (чистый контекст).
- `/stats` — статистика (модель, стиль, режим RAG, кол-во документов в контексте).
- `/kb` — **автосинк** + выбор документов (чекбоксы) для RAG.
- `/model` — выбор модели (gpt-4o, gpt-4o-mini, gpt-4.1-mini, o3-mini, o1-mini).
- `/mode` — стиль ответа (Pro/Expert/User/CEO).
- `/dialogs` — список диалогов (открыть/удалить, + создать новый).
- `/img <prompt>` — сгенерировать изображение.
- `/web <запрос>` — веб-поиск с источниками.

## Логика RAG/БЗ
1. При `/kb` бот **всегда** делает синхронизацию каталога БЗ и показывает список документов.
2. Пользователь отмечает нужные документы чекбоксами и нажимает «Готово».
3. При ответе на текст/голос бот, если есть выбранные документы, сначала **извлекает** релевантные чанки и формирует **контекст**.  
   Ответ LLM строится с явным системным указанием опираться на этот контекст.
4. Если БД Postgres с расширением `pgvector` доступна — RAG-режим `db`. Если нет — `on-disk` fallback.
5. В `/stats` видно: режим RAG (db/on-disk/off) и количество документов в контексте.

## Настройка БД и pgvector
- Переменная окружения `DATABASE_URL` (или `POSTGRES_URL`) может быть в форме `postgres://...`.  
  Мы **нормализуем** URL до `postgresql+psycopg2://...` автоматически.
- Для режима `db` требуется расширение `pgvector` в вашей БД Postgres.
- При недоступности — автоматически включается `on-disk` режим (демо: поиск по подстроке; замените на FAISS/HNSW при желании).

## Зависимости
См. `requirements.txt`. Обратите внимание: добавлены `beautifulsoup4`, `lxml`, `numpy`.

## Замечания по деплою
- Ошибка `Conflict: terminated by other getUpdates request` означает, что запущено **несколько** инстансов бота. Оставьте один.
- Для изображений в PTB20 **не** используйте `InputFile.from_bytes`; достаточно `io.BytesIO` с атрибутом `name`.
- Если `KB unavailable` — убедитесь, что папки `bot/knowledge_base/*` присутствуют, а `KnowledgeBaseIndexer` и `KnowledgeBaseRetriever` импортируются.
