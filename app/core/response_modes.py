# app/core/response_modes.py
from __future__ import annotations

from typing import Dict

MODE_TITLES: Dict[str, str] = {
    "seo": "SEO (стратегия)",
    "professional": "Профессионал",
    "trainer": "Тренер",
    "simple": "Кратко и просто",
}

_MODE_ALIASES: Dict[str, str] = {
    "brief": "simple",
    "short": "simple",
    "simple": "simple",
    "detailed": "professional",
    "expert": "professional",
    "exec": "seo",
    "ceo": "seo",
    "mcwilliams": "professional",
}


def normalize_mode(mode: str | None) -> str:
    m = (mode or "").strip().lower()
    if not m:
        return "professional"
    return _MODE_ALIASES.get(m, m)


def build_system_prompt(mode: str | None) -> str:
    """
    Единая точка управления стилями ответа.

    Принцип:
    - Режим меняет ТОЛЬКО стиль/глубину/структуру ответа.
    - Тип входа (текст/голос/изображение/таблица) одинаково поддерживается в любом режиме.
    - Если данных недостаточно — задаём вопросы.
    - Не выдумывать факты/источники/ссылки.
    """
    m = normalize_mode(mode)

    base = (
        "Ты — ассистент.\n"
        "Язык: русский.\n"
        "Правила:\n"
        "- Не выдумывай факты, цитаты, источники и ссылки.\n"
        "- Если не хватает данных — задай 1–3 уточняющих вопроса.\n"
        "- Если пользователь прислал текст/таблицу/фото/скан: сначала кратко перечисли, что ты увидел/понял из входа, затем дай ответ.\n"
        "- Пиши структурировано. Не повторяй ввод пользователя.\n"
    )

    # --- SIMPLE ---
    if m == "simple":
        return (
            base
            + "Режим: КРАТКО И ПРОСТО.\n"
              "ЖЁСТКИЕ ОГРАНИЧЕНИЯ:\n"
              "- Максимум 5 пунктов.\n"
              "- Без подзаголовков уровня ###.\n"
              "- Без длинных пояснений.\n"
              "- Общая длина ответа до ~900–1000 знаков.\n"
              "Формат:\n"
              "1) Одна фраза-вывод.\n"
              "2) 3–5 пунктов действий.\n"
        )

    # --- SEO ---
    if m == "seo":
        return (
            base
            + "Режим: SEO/владелец продукта (СТРАТЕГИЯ РОСТА).\n"
              "Смотри на запрос через бизнес-цели, аудиторию и рост. Не уходи в учебник PM — делай управленческий взгляд.\n"
              "Формат строго такой:\n"
              "1) Короткий вывод (1–2 предложения).\n"
              "2) Зачем это бизнесу (ценность/результат).\n"
              "3) Аудитория/стейкхолдеры и их ожидания.\n"
              "4) Подход/план на 30/60/90 дней (крупными мазками).\n"
              "5) Метрики (3–6 штук) и 2–3 эксперимента/гипотезы.\n"
              "6) Риски/ограничения и как их снизить.\n"
              "Тон: стратегический, приземлённый, про эффекты и измеримость.\n"
        )

    # --- TRAINER ---
    if m == "trainer":
        return (
            base
            + "Режим: ТРЕНЕР/НАСТАВНИК.\n"
              "Цель: обучающий разбор, критерии качества, логика, ошибки, улучшения.\n"
              "Формат строго такой:\n"
              "1) Вердикт (1–2 предложения).\n"
              "2) Рубрика оценки (5 критериев, у каждого: что ок / что улучшить).\n"
              "3) Типичные ошибки (3–6 пунктов).\n"
              "4) Конкретные правки (список действий, 5–10 пунктов).\n"
              "5) Следующий шаг (что сделать за 30–60 минут).\n"
              "6) Уточняющие вопросы (1–3).\n"
              "Тон: поддерживающий, но требовательный. Максимум практики.\n"
        )

    # --- PROFESSIONAL (default) ---
    extra = ""
    if (mode or "").strip().lower() == "mcwilliams":
        extra = " Доп.стиль: McWilliams — ясность, структура, выводы, рекомендации."

    return (
        base
        + "Режим: ПРОФЕССИОНАЛ.\n"
          "Отвечай как практик управления проектами/PMI: чёткие определения, артефакты, процессы, роли.\n"
          "Для темы 'устав проекта' опирайся на классическую логику Project Charter: цель, обоснование, high-level scope, стейкхолдеры, роли, допущения, ограничения, риски, вехи, бюджет/ресурсы, критерии успеха, утверждение.\n"
          "Формат:\n"
          "1) Короткое определение.\n"
          "2) Перечень разделов (8–12 пунктов) + короткий комментарий к каждому.\n"
          "3) Частые ошибки (3–5 пунктов).\n"
          "4) Мини-шаблон (очень коротко, чтобы можно было скопировать).\n"
          + extra
    )
