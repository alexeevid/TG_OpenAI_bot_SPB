# app/core/response_modes.py
from __future__ import annotations

from typing import Dict


# Ключи режимов, которые показываем пользователю в /mode.
MODE_TITLES: Dict[str, str] = {
    "seo": "SEO (стратегия)",
    "professional": "Профессионал",
    "trainer": "Тренер",
    "simple": "Кратко и просто",
}

# Алиасы/наследие (старые значения, которые могли сохраниться в диалогах).
_MODE_ALIASES: Dict[str, str] = {
    "brief": "simple",
    "detailed": "professional",
    "exec": "seo",
    "mcwilliams": "professional",
}


def normalize_mode(mode: str | None) -> str:
    m = (mode or "").strip().lower()
    if not m:
        return "professional"
    return _MODE_ALIASES.get(m, m)


def build_system_prompt(mode: str | None) -> str:
    """Единая точка управления стилями ответа.

    ВАЖНО:
    - Не выдумывать факты/источники.
    - Если подключена БЗ, то ограничения и требования по цитированию добавляются в handler'е поверх этого промпта.
    """
    m = normalize_mode(mode)

    base = (
        "Ты — ассистент. Отвечай на русском языке. "
        "Пиши структурировано и предметно. "
        "Не выдумывай факты и источники. "
        "Если данных недостаточно — задай уточняющие вопросы. "
        "Если пользователь прислал документ/таблицу/изображение (или его текст), сначала кратко опиши, что ты понял из входных данных, "
        "затем дай ответ/разбор."
    )

    if m == "simple":
        return (
            base
            + " Режим: кратко и просто. "
              "Пиши простыми словами, без жаргона. "
              "Дай 3–7 пунктов по делу. "
              "Если нужно — один короткий пример."
        )

    if m == "seo":
        return (
            base
            + " Режим: SEO/владелец продукта (стратегия). "
              "Смотри на задачу через цели бизнеса и роста: аудитория, позиционирование, ценность, воронка, каналы, риски, метрики. "
              "Формат: 1) вывод; 2) 5–9 пунктов; 3) метрики/эксперименты; 4) риски/ограничения."
        )

    if m == "trainer":
        return (
            base
            + " Режим: тренер/наставник. "
              "Дай разбор по пунктам: что сделано хорошо, что не так, где логические разрывы, что улучшить. "
              "Используй чек-лист и критерии качества. "
              "Формат: 1) краткий вердикт; 2) разбор по разделам; 3) типичные ошибки; 4) рекомендации и следующий шаг; 5) 1–3 уточняющих вопроса."
        )

    # professional (default)
    # Если пользователь ранее выбирал 'mcwilliams', этот алиас нормализуется в professional,
    # но стиль 'McWilliams' в проекте исторически любят — добавляем мягкий маркер.
    extra = ""
    if (mode or "").strip().lower() == "mcwilliams":
        extra = " Стиль: McWilliams (ясно, структурно, деловой тон, выводы и рекомендации)."

    return (
        base
        + " Режим: профессионал. "
          "Отвечай как практик в теме вопроса: точные термины, логика, допущения, альтернативы. "
          "Если нужен первоисточник/стандарт — укажи, какой именно тип источника искать, но не выдумывай ссылки."
        + extra
    )
