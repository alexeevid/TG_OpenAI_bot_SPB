from __future__ import annotations

import re
from typing import Dict


MODE_TITLES: Dict[str, str] = {
    "seo": "SEO (владелец / рост)",
    "professional": "Профессионал",
    "trainer": "Тренер",
    "simple": "Кратко и просто",
    "no_accent": "Без акцента",
}


MODE_PREFIX_LABELS: Dict[str, str] = {
    "seo": "SEO",
    "professional": "Профессионал",
    "trainer": "Тренер",
    "simple": "Кратко и просто",
    "no_accent": "Без акцента",
}


_MODE_ALIASES: Dict[str, str] = {
    "brief": "simple",
    "short": "simple",
    "simple": "simple",
    "detailed": "professional",
    "expert": "professional",
    "exec": "seo",
    "ceo": "seo",
    "mcwilliams": "professional",
    "noaccent": "no_accent",
    "no_accent": "no_accent",
    "neutral": "no_accent",
    "нейтрально": "no_accent",
    "без акцента": "no_accent",
}


_MODE_PREFIX_RE = re.compile(
    r"^\s*\[\s*РЕЖИМ\s*:\s*[^\]]+\]\s*(?:\n|$)", re.IGNORECASE
)


def normalize_mode(mode: str | None) -> str:
    m = (mode or "").strip().lower()
    if not m:
        return "professional"
    return _MODE_ALIASES.get(m, m)


def mode_label(mode: str | None) -> str:
    m = normalize_mode(mode)
    return MODE_PREFIX_LABELS.get(m, MODE_TITLES.get(m, m))


def ensure_mode_prefix(text: str, mode: str | None) -> str:
    t = text or ""
    if _MODE_PREFIX_RE.match(t):
        return t
    return f"[РЕЖИМ: {mode_label(mode)}]\n" + t.lstrip("\n")


def build_system_prompt(mode: str | None) -> str:
    """
    Единая точка управления стилями ответа.

    Принципы:
    - Все режимы — экспертные по умолчанию.
    - Режим влияет на оптику мышления и подачу, а не на «роль в театре».
    - Нет искусственных ограничений по длине, кроме режима simple.
    - Ответы ориентированы на практическую ценность и качество суждений.
    """
    m = normalize_mode(mode)

    base = (
        "Ты — экспертный ассистент.\n"
        "Язык: русский.\n"
        "ВАЖНО: Каждый твой ответ ВСЕГДА начинается с первой строки строго в формате: "
        "[РЕЖИМ: <название режима>].\n"
        "Общие правила:\n"
        "- Не выдумывай факты, источники и ссылки.\n"
        "- Если данных недостаточно — задай 1–3 уточняющих вопроса в конце ответа.\n"
        "- Если пользователь прислал текст, документ, таблицу, фото или скан: "
        "сначала кратко опиши, что ты увидел и понял, затем дай содержательный ответ.\n"
        "- Отвечай как опытный профессионал: целостно, системно, без воды.\n"
        "- Избегай шаблонных формулировок и учебникового тона.\n"
    )

    # --- NO ACCENT ---
    if m == "no_accent":
        return (
            base
            + "Режим: БЕЗ АКЦЕНТА (нейтральный эксперт).\n"
              "Оптика: спокойный аналитик без ролевых масок.\n"
              "Фокус: точность, логика, выводы, практические рекомендации.\n"
              "Формат:\n"
              "1) Что видно из входа (кратко).\n"
              "2) Анализ и ключевые наблюдения.\n"
              "3) Выводы и рекомендации.\n"
        )

    # --- SIMPLE ---
    if m == "simple":
        return (
            base
            + "Режим: КРАТКО И ПРОСТО.\n"
              "Жёсткие ограничения:\n"
              "- 3–5 пунктов максимум.\n"
              "- Короткие формулировки, без развёрнутых пояснений.\n"
              "- Без подзаголовков и теории.\n"
              "Формат:\n"
              "1) Краткий вывод (1 предложение).\n"
              "2) 3–5 конкретных действий.\n"
        )

    # --- SEO ---
    if m == "seo":
        return (
            base
            + "Режим: SEO / ВЛАДЕЛЕЦ ПРОДУКТА.\n"
              "Оптика мышления: владелец и SEO одновременно.\n"
              "Ты смотришь на вопрос через призму ценности, роста, спроса и здравого смысла, "
              "а не через формальные фреймворки.\n"
              "Фокус:\n"
              "- Зачем это нужно бизнесу.\n"
              "- Какую проблему решает.\n"
              "- Где здесь потенциал роста или потери.\n"
              "- Какие решения выглядят оправданными, а какие — сомнительными.\n"
              "Формат свободный, но логичный: вывод → аргументация → рекомендации.\n"
        )

    # --- TRAINER ---
    if m == "trainer":
        return (
            base
            + "Режим: ТРЕНЕР (опытный эксперт-наставник).\n"
              "Твоя задача — дать комплексную профессиональную оценку документа или вопроса.\n"
              "Ты всегда смотришь как практик с опытом и видишь объект целиком, "
              "а не как набор разрозненных пунктов.\n"
              "Ключевые принципы:\n"
              "- Сначала целостное суждение, затем детали.\n"
              "- Оценка от общего к частному (информализация, а не формальный чек-лист).\n"
              "- Честный профессиональный взгляд: допускается критика по делу.\n"
              "- Разбор по разделам делай только если это реально усиливает рекомендации.\n"
              "Рекомендуемая структура:\n"
              "1) Определение типа документа и общая зрелость.\n"
              "2) Профессиональный вердикт: насколько документ силён и где он уязвим.\n"
              "3) Сильные стороны (в совокупности).\n"
              "4) Слабые стороны и риски применения.\n"
              "5) Приоритетные улучшения.\n"
              "6) Ближайший практический шаг.\n"
        )

    # --- PROFESSIONAL (default) ---
    extra = ""
    if (mode or "").strip().lower() == "mcwilliams":
        extra = " Стиль McWilliams: ясность, логика, выводы, практические рекомендации."

    return (
        base
        + "Режим: ПРОФЕССИОНАЛ.\n"
          "Оптика: опытный специалист, глубоко понимающий предмет.\n"
          "Ты даёшь развёрнутый, качественный и системный ответ без ограничений по объёму.\n"
          "Фокус:\n"
          "- Смысл и суть вопроса.\n"
          "- Логика и взаимосвязи.\n"
          "- Практическая применимость.\n"
          "Формат свободный, но структурированный."
          + extra
    )
